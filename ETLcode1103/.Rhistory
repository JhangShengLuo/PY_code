print('finished')
Sys.Date()
Sys.Date()
Sys.time()
print(Sys.time())
print(Sys.time())
Sys.setlocale(category = "LC_CTYPE", locale= "zh_CN.UTF-8")
t=read.table("/Users/Jackie/Desktop/ETLcode1103/allappend.csv",  header = TRUE, sep = ",")
t=data.frame(t)
t[t$方向=="向東",]$方向="往東"
t[t$方向=="向西",]$方向="往西"
day=c( "Mon","Tue" ,"Wed","Thu","Fri" , "Sat" ,"Sun"  )
lp=levels( factor(t$位置) )
meq=matrix(0,1,length(lp))
for (i in 1:length(lp)) {
meq[i]=mean(t[t$位置==lp[i]&t$平均佔有率>5&t$平均佔有率<6,]$當量)*2
}
ti=c("08:00:00","09:00:00","18:00:00","19:00:00")
prs=matrix(0,4,5)
lpm=rs=0
for (k in 1:4) {
for (j in 1:5) {
#模型分類
for (i in 1:length(lp)) {
di=levels(factor(t[t$位置==lp[i],]$方向))
lpm[i]=median(t[t$位置==lp[i]&t$時間==ti[k]&t$星期==day[j]&t$方向==di[1],"當量"])
}
a1=a2=a3=0
r1000=r500=r0=0
for (i in 1:length(lp)) {
if(lpm[i]>1000){
a1=a1+1
r1000[a1]=lp[i]
}else if (lpm[i]>500){
a2=a2+1
r500[a2]=lp[i]
}else{
a3=a3+1
r0[a3]=lp[i]
}
}
#r1000
#r500
#r0
#建模
t1000=t500=t0=t[t$道路==0,]
for (i in 1:length(r1000)) {
t1000=rbind(t1000,t[t$位置==r1000[i],])
}
#t1000
for (i in 1:length(r500)) {
t500=rbind(t500,t[t$位置==r500[i],])
}
for (i in 1:length(r0)) {
t0=rbind(t0,t[t$位置==r0[i],])
}
modelt1000=lm(當量~位置+時間+星期+道路數+平均速度+平均佔有率+平均車間距,data = t1000)
#summary(modelt1000)
if (lengths(levels( factor( t500$位置 ) ))>1){
modelt500=lm(當量~位置+方向+時間+星期+道路數+平均速度+平均佔有率+平均車間距,data = t500)
}else{
modelt500=lm(當量~時間+星期+平均速度+平均佔有率+平均車間距,data = t500)
}
#summary(modelt500)
if (lengths(levels( factor( t0$位置 ) ))!=1){
modelt0=lm(當量~位置+方向+時間+星期+道路數+平均速度+平均佔有率+平均車間距,data = t0)
}else{
modelt0=lm(當量~時間+星期+平均速度+平均佔有率+平均車間距,data = t0)
}
#summary(modelt0)
#prs[k,j]=summary(modelt0)$adj.r.squared+summary(modelt500)$adj.r.squared+summary(modelt1000)$adj.r.squared
if ((summary(modelt0)$adj.r.squared+summary(modelt500)$adj.r.squared+summary(modelt1000)$adj.r.squared)>rs){
rs=summary(modelt0)$adj.r.squared+summary(modelt500)$adj.r.squared+summary(modelt1000)$adj.r.squared
r0m=r0;r500m=r500;r1000m=r1000
t0m=t0;t500m=t500;t1000m=t1000
}
}
}
modelt1000=lm(當量~位置+方向+時間+星期+道路數+平均速度+平均佔有率+平均車間距,data = t1000m)
if (lengths(levels( factor( t500m$位置 ) ))>1){
modelt500=lm(當量~位置+方向+時間+星期+道路數+平均速度+平均佔有率+平均車間距,data = t500m)
}else{
modelt500=lm(當量~時間+星期+平均速度+平均佔有率+平均車間距,data = t500m)
}
if (lengths(levels( factor( t0m$位置 ) ))>1){
modelt0=lm(當量~位置+方向+時間+星期+道路數+平均速度+平均佔有率+平均車間距,data = t0m)
}else{
modelt0=lm(當量~方向+時間+星期+平均速度+平均佔有率+平均車間距,data = t0m)
}
#表格
ti=c("a","p")
ti1=c("08:00:00","18:00:00")
ti2=c("09:00:00","19:00:00")
di1=c("往東","往西")
di2=c("往北","往南")
di11=c("E","W")
di12=c("N","S")
#t[t$位置=="塔悠路-(舊宗一號公園56號燈桿旁",]$道路[1]
#t[t$位置=="塔悠路-(舊宗一號公園56號燈桿旁",]$VD編號[1]
ma=length(lp)*2*5*2
ta=matrix(0,ma,8)
ta=data.frame(ta)
i=0
for (i1 in 1:length(lp)) {
for (i2 in 1:2) {
for (i3 in 1:5) {
for (i4 in 1:2) {
i=i+1
ta[i,2]=as.character(t[t$位置==lp[i1],]$道路[1])
ta[i,3]=lp[i1]
if ("往東"%in%t[t$位置==lp[i1],]$方向||"往西"%in%t[t$位置==lp[i1],]$方向 ) {
ta[i,1]=as.character(t[t$位置==lp[i1]&t$方向==di1[i2],]$VD編號[1])
ta[i,4]=di11[i2] #方向
ta[i,7]=round(mean(t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4]&t$方向==di1[i2],]$當量+t[t$位置==lp[i1]&t$星期==day[i3]&t$時間==ti2[i4]&t$方向==di1[i2],]$當量))
ta[i,8]=round((1-pnorm(meq[i1],mean =ta[i,7],sd=sd(t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4]&t$方向==di1[i2],]$當量+t[t$位置==lp[i1]&t$星期==day[i3]&t$時間==ti2[i4]&t$方向==di1[i2],]$當量)))*100)
}else if ("往北"%in%t[t$位置==lp[i1],]$方向||"往南"%in%t[t$位置==lp[i1],]$方向 ) {
ta[i,1]=as.character(t[t$位置==lp[i1]&t$方向==di2[i2],]$VD編號[1])
ta[i,4]=di12[i2] #方向
ta[i,7]=round(mean(t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4]&t$方向==di2[i2],]$當量+t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4]&t$方向==di2[i2],]$當量))
ta[i,8]=round((1-pnorm(meq[i1],mean =ta[i,7],sd=sd(t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4]&t$方向==di2[i2],]$當量+t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4]&t$方向==di2[i2],]$當量)))*100)
}else{
if(i2==1){
ta[i,1]=as.character(t[t$位置==lp[i1],]$VD編號[1])
ta[i,4]="U"
ta[i,7]=round(mean(t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4],]$當量+t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4],]$當量))
ta[i,8]=round((1-pnorm(meq[i1],mean =ta[i,7],sd=sd(t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4],]$當量+t[t$位置==lp[i1]&t$星期==day[i3]& t$時間==ti1[i4],]$當量)))*100)
}else{
}
}
ta[i,5]=i3-1 #星期
ta[i,6]=ti[i4] #上下午
}
}
}
}
ta=ta[ta$X1!=0,]
ta=na.omit(ta)
colnames(ta)=c("VD編號","道路","位置","方向","星期","時段","預測當量","塞車機率")
ta[,8]=paste0(ta[,8],"%")
#輸出
write.table(ta, file = "/Users/Jackie/Desktop/ETLcode1103/results.csv",row.names =FALSE,sep = ",")
print(Sys.time())
